import requests
import json
import os
from dotenv import load_dotenv
from src.util.gmail_util import send_gmail
from src.util.youtube_util import search_youtube, get_transcript
from src.util.perplexity_util import summarize_text
import html

load_dotenv()  # Load environment variables from .env

def main():
    handles = ["@GeorgeGammon", "@RebelCapitalistInterviews", "@GoldSilver", "@NeilMcCoyWard", "@HOWGG"]
    results = []
    for handle in handles:
        videos = search_youtube(handle, 14)
        for v in videos:
            video_id = v["video_id"]
            # transcript = get_transcript(video_id)
            # transcript = "Breaking news. The government has officially cancelled all future recessions. Unemployment will never go up again. >> Now, that may have been AI, but it wasn't necessarily fake news. Based on recent events, the government may be trying to cancel all future recessions. I'm going to explain exactly what I'm referring to and how you can differentiate between the propaganda and the actual truth in three simple fast steps. Step number one, let's go over WTF is the NBER. This is the National Bureau of Economic Research. Why do they matter? Because in the past, they're the ones that officially came out and said whether or not the United States economy had been in contraction. So, it doesn't matter how bad the economy is. If they don't say it's bad, well, then you better shut up and believe them. It ain't bad. So, we're going to start by looking at a chart of the unemployment rate in the United States from today's date going all the way back to 1980. On the left, we go from 0% up to 14%. Now, in 1980, the early 80s, as most of you know, we were in a recessionary period. We had a couple recessions there with Reagan and Vulkar. Now, before we move any further, I want you to notice these red arrows. All right. Now, the first move up in the unemployment rate that we saw in let's say 1980 or right around that time that coincided with a, you guessed it, a recession. And a recession that the NBER actually admitted to. Now we fast forward. We have a dip down, but then we have another recession. You could call this a double dip recession where the unemployment rate goes even higher. And yes, we have another red arrow. Now, we fast forward to the beginning of the 1990s and we see another spike in the unemployment rate that corresponds with another red arrow. Exact same thing during the dot blow up. Exact same thing during the GFC, exact same thing during the surveys sickness. But I want you to notice right here, 2022. Why is this important? Why is this key to step number one? Because we actually had two quarters of negative GDP when you adjust for inflation. Now, historically, this has been a technical recession, but the NBER never admitted that we had an economic contraction. Therefore, the market didn't trade as if we did. So, as an example, if you had been a market commentator and at the beginning of 2022 said, \"We're in a recession,\" you would have been proven wrong because the NBER didn't agree with you. Although we did have a contraction, an economic contraction when you adjust for inflation. So it brings us to our first point here. Who actually is the arbiter of truth? Is it the average Joe and Jane or is it the central planners? Which brings us to another question which is at the end of the day what really matters? is it's what's happening with the economy or how the market perceives what's happening in the economy. Well, if you're an investor, you have a 401k, you're setting up a portfolio, the only thing you really care about looking at it through that lens is what's happening with the marketplace. So, this would mean that you're hyperfocused on the NBER and their announcements as to whether or not we've been in a recession because, you know, that's the only thing that's actually going to move the market. But if you're the average Joe and Jane and you live in the real economy, then it's a much different equation. You don't care about what these guys say. You don't care about the central planners. The only thing you care about is your lived experience. And if you find it very difficult to get a job and you're hearing the exact same thing from all your friends and family members and if your standard of living is going down, that effectively is the only type of recession or economic contraction you care about. So what this all boils down to is what is the most important thing to you? Is it reality or is it the data? You know, the great example of this would be the CPI. Most of you watching this video would say that the CPI understates the rate of inflation based on your lived experience. So, at the end of the day, what really matters, the government data or your standard of living? So, hopefully you can see where I'm going with this. If the government comes out and just cancels all recessions by never allowing the data to show that the unemployment rate is higher than 4.2%. Does it matter? Does it matter in the real economy and does it matter in the market? Regardless of your answer, I'm sure every single one of you wants to know how on earth we differentiate between the propaganda and the truth. How do we find that signal through all of the economic government data noise? The good news is I'm going to be answering that question for you throughout the rest of this video. Step number two. Now, let's go straight over to the NBER's website to determine what inputs they use to come to this conclusion that's so official that yes, the United States economy has been in a contraction. So, we start off with this post, business cycle dating. I think this is just a fancy way of saying recession. They go over the chart that we used in step number one. And I think it's interesting they start off with a chart of the unemployment rate. What this tells me is that is their number one input. And when we get into the article, we see they say, \"Because a recession must influence the economy broadly and not be confined to one sector, the committee emphasizes economywide measures of economic activity. The determination of the months of peaks and troughs is based on a range of monthly measures of aggregate real economic activity published by the federal statistical agencies. In other words, all the inputs they use to come to this very important decision that the market trades on comes directly from government controlled data. These include real personal income less transfers, non-farm payroll employment. More on that just a moment. Employment as measured by the household survey. More on that in just a moment. real personal consumption expenditures, manufacturing and trade sales adjusted for price changes, industrial production. There is no fixed rule about what measures contribute information to the process or how they're weighted, right? But let me remind everyone, you started off this entire post by showing a chart of official recessions and the unemployment rate. So, if I'm just using some good old-fashioned common sense, I think that holds the biggest weight for the NBER. So, why is this so important? Let's go right over to the BLS website, the Bureau of Labor Statistics, and you'll see exactly what I'm referring to. They have a recent report that showed the headline number in the establishment survey, this is non-farm payrolls, was 73,000. This was much lower than what was expected. But the real kicker was the revisions to the two months prior. Let me show you what I'm referring to. You see these red lines? These show when the revisions to the two months prior have been negative. The gray bars or lines show when they have been positive. Now I want you to notice this last report that we got the revisions downward when you combine the last two months was 258,000. That is a huge number. And just to give you some context, the last couple months the headline number was right around 130 140,000 which beat expectations. The market thought that was fantastic. But then when they were revised they go all the way down to like positive4 positive 19 basically flat. So this is a huge huge deal and in fact this was the biggest revision we have had since 2020 the surveys and it was an even bigger downward revision than we saw throughout the entire GFC. And one more thing I'd like to note is we have never seen this big of a downward revision outside of an official recession. Now, I know a lot of you right about now are probably saying to yourself, \"Okay, George, I get it. The NBER prioritizes the unemployment rate or the labor market, and it's a lot softer than we thought it was prior to this report coming out. But what does that have to do with the government cancelling all future recessions? I'm glad you asked. We're going to get into that right now. Step number three, you're fired. Now, most of you know once Donald Trump saw the data, he actually fired the gal that was in charge over at the BLS. So, now we're starting to connect the dots. We're going to put the pieces of the puzzle together and go through this thought experiment where we're trying to figure out, have the United States recessions been cancelled by the government? Will we ever have one again? So Trump came out and said the reason he fired this gal because she was behaving in a political fashion. She wanted to make him look bad. So she was rigging these numbers. and he correctly pointed back to 2024 when the headline number was way way way overstated and he said this was due to the fact they were trying to get Biden or Camala elected. Now I don't know if that's true or not. This is Trump's view. Now regardless of whether or not she was doing this for political reasons, I think she should have been fired. Why? Because if it's not political, it's gross incompetence. When you look at how bad the data has been going all the way back to 2024 for the last two years, you have to come to one of two conclusions. Either she is completely and totally incompetent or the method she is using is bad, which is almost one and the same because if she was competent, she could see that the method was flawed and she would change it. So, I don't know if this was political, but regardless, I agree with Trump firing her, but it still puts us in a very precarious position. Now, before we move on, I would say my base case is that it's incompetence. It wasn't political. Because if she was rigging the headline number in 2024, why would she not do that again with Trump? Why would she rig the revisions? Hm. Just throwing that out there. But regardless, I'll let you come to your own conclusion. I don't want this video to be about politics. But where this is really important is looking forward into the future. So regardless of whether Trump puts in a yes man or they just have this kind of looming over their head where they know that if they actually admit that the labor market is softening, if the unemployment rate increases, they know they're going to get the axe. So they are highly incentivized, even if it's not Trump's intention to put in a yes man, they're highly incentivized to make sure the numbers are, let's say, overly optimistic. So if they're doing this and the unemployment rate stays the same or stays low, then we know the odds are that NBER is never going to come out and admit we're in a recession, no matter how bad the underlying economy gets. So why does this matter? It goes back to what we were talking about in step number one where we're trying to figure out have economic recessions just been cancelled for the United States in the future or at least for the next three years. Well, the punchline here is for the real economy, the average Joe and Jane, this doesn't matter at all because as you guys know, as it pertains to your job, your standard of living, you don't care what government data is telling you because it's all about your lived experience, like we were saying before. But for the marketplace, unfortunately, the only thing that matters is that they just have a positive narrative. You guys know that the stock market is at nosebleleed levels. And regardless of whether you think it's going higher or lower, you have to admit that it is extremely extremely overpriced when you look at the PE ratios and what they have been historically. So even if the economy is crumbling and you're losing your job, your friends are losing your job, your standard of living is going down for the marketplace, it really doesn't matter as long as they have a positive narrative to spin and sell. And as long as the NBER doesn't come out and announce that we're in an economic contraction, the market has an excuse to go higher and higher and higher. So, how do you tell the truth? Where do we get the signal with all of this noise? Well, I think you have to now prioritize realworld data as opposed to the government data that we're getting from places like the BLS or the NBER. You can throw them in there as well. So, what is an example of real world data? Well, let's look at this chart. We go all the way back to 2004 to today's date. On the left, we go from 94 up to 108. Anything less than 100, you're in the no bueno zone. This indicates that you're likely in a recession. And this is the RPI, the restaurant performance indicator. No better reflection of the real economy, what people are doing with discretionary income than what's happening at movie theaters, malls, bars, restaurants. So if you see this, as you would expect going into 2009, it went negative in the GFC, then it came back up, then it goes negative again during the surveys sickness, goes negative in 2024, kind of pops back up, goes back down. Right now, we're on the borderline. So, if I really wanted to know what was going on, I would start paying less attention to the non-farm payrolls and start paying more attention to data points like this. That isn't very easily manipulated by the government. Also, interest rates. You guys know from watching my videos, the yield curve inverted about two years ago. Now, that doesn't necessarily mean that you're in a contraction or the stuff is about to hit the fan, but what it does mean is that you're likely to see an economic slowdown with nominal GDP, which is exactly what we've seen. Now, it has steepened out. It is no longer inverted, but that's usually when you have the biggest problem with the economy. So, moving forward, I would combine these two things, and that's how I would determine what's really happening beneath the surface. If you want more intel just like this, or you want to know what I'm doing with my own portfolio, or how my good friends like Lynn Alden, Chris Macintosh, Brent Johnson are navigating this insane world that we're living in right now. You can check out my free weekly newsletter. It's Rebel Capitalist Pro Report, and you can get access to that right now at the link in the description of this video."
            # summary = summarize_text(transcript) if transcript else None
            
            # Clean up the title to be human readable
            raw_title = v.get("title")
            readable_title = html.unescape(raw_title)
            # print(f"Readable title: {readable_title}")
            
            results.append(
                {
                    "channel": handle,
                    "channel_url": f"https://www.youtube.com/{handle}",
                    "raw_title": raw_title,
                    "title": readable_title,
                    "video_id": video_id,
                    "url": f"https://www.youtube.com/watch?v={video_id}",
                    "published": v.get("published"),
                    # "transcript": transcript,
                    # "summary": summary
                }
            )
    results.sort(key=lambda x: x["published"], reverse=True)
    send_gmail(
        "YouTube Daily Digest", json.dumps(results, ensure_ascii=False, indent=2), "pohualin@gmail.com"
    )
    with open("results.json", "w") as f:
        json.dump(results, f, ensure_ascii=False, indent=2)


if __name__ == "__main__":
    main()
